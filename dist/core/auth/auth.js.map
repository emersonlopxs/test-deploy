{"version":3,"sources":["../../../src/core/auth/auth.js"],"names":["auth","req","res","next","authorization","headers","unauthorizedError","UnauthorizedError","token","query","startsWith","replace","helpers","jwt","verify","err"],"mappings":";;;;;;;;;AAAA;;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACO,eAAeA,IAAf,CAAoBC,GAApB,EAAyBC,GAAzB,EAA8BC,IAA9B,EAAoC;AACzC,QAAM;AAAEC,IAAAA;AAAF,MAAoBH,GAAG,CAACI,OAA9B;AACA,QAAMC,iBAAiB,GAAG,IAAIC,yBAAJ,EAA1B;AAEA,MAAIC,KAAJ;;AAEA,MAAIP,GAAG,CAACQ,KAAJ,CAAUD,KAAd,EAAqB;AACnBA,IAAAA,KAAK,GAAGP,GAAG,CAACQ,KAAJ,CAAUD,KAAlB;AACA,WAAOP,GAAG,CAACQ,KAAJ,CAAUD,KAAjB;AACD,GAHD,MAGO;AACL,QAAI,CAACJ,aAAL,EAAoB,OAAOD,IAAI,CAACG,iBAAD,CAAX;AAEpB,QAAI,CAACF,aAAa,CAACM,UAAd,CAAyB,SAAzB,CAAL,EAA0C,OAAOP,IAAI,CAACG,iBAAD,CAAX;AAE1CE,IAAAA,KAAK,GAAGJ,aAAa,CAACO,OAAd,CAAsB,UAAtB,EAAkC,EAAlC,CAAR;AACD;;AAED,MAAI;AACFV,IAAAA,GAAG,CAACD,IAAJ,GAAW,MAAMY,OAAO,CAACC,GAAR,CAAYC,MAAZ,CAAmBN,KAAnB,CAAjB;AACD,GAFD,CAEE,OAAOO,GAAP,EAAY;AACZ,WAAOZ,IAAI,CAACY,GAAD,CAAX;AACD;;AAED,SAAOZ,IAAI,EAAX;AACD","sourcesContent":["import * as helpers from \"~/helpers\";\nimport { UnauthorizedError } from \"~/errors\";\n\n/**\n * Authentication middleware\n *  - Check for authorization baerer token\n *  - Validate the token\n *  - Put its payload on req.auth\n */\nexport async function auth(req, res, next) {\n  const { authorization } = req.headers;\n  const unauthorizedError = new UnauthorizedError();\n\n  let token;\n\n  if (req.query.token) {\n    token = req.query.token;\n    delete req.query.token;\n  } else {\n    if (!authorization) return next(unauthorizedError);\n\n    if (!authorization.startsWith(\"Bearer \")) return next(unauthorizedError);\n\n    token = authorization.replace(/Bearer /g, \"\");\n  }\n\n  try {\n    req.auth = await helpers.jwt.verify(token);\n  } catch (err) {\n    return next(err);\n  }\n\n  return next();\n}\n"],"file":"auth.js"}