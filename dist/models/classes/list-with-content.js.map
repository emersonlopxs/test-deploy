{"version":3,"sources":["../../../src/models/classes/list-with-content.js"],"names":["formatClasses","value","trans","Promise","all","map","item","id","title","teacher","teacherId","userId","teacherUserId","name","teacherName","subjects","select","contents","childClasses","student","classIds","keyword","byGrade","limit","offset","loggedUserId","rows","join","then","count","total","first","filters"],"mappings":"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","sourcesContent":["/* eslint-disable no-param-reassign */\nimport { like, beginTransaction } from \"~/core/database\";\n\nconst formatClasses = async (value, trans) =>\n  Promise.all(\n    value.map(async item => ({\n      id: item.id,\n      title: item.title,\n      teacher: {\n        id: item.teacherId,\n        userId: item.teacherUserId,\n        name: item.teacherName,\n      },\n      subjects: await trans.select(\n        `\n        select\n          S.id,\n          S.name,\n          S.color,\n          S.description\n        from classesSubjects as CS\n        join subjects as S on S.id = CS.subjectId\n        where CS.classId = ?\n        `,\n        [item.id]\n      ),\n      contents: await trans.select(\n        `\n        select\n          CC.id,\n          CC.thumbnail,\n          CC.url,\n          CC.type,\n          CC.description\n        from classesContents as CC\n        join classes as C on C.id = CC.classId\n        where CC.classId = ?\n        `,\n        [item.id]\n      ),\n      childClasses: await trans.select(\n        `\n        select\n          CC.childClassId\n        from classesClasses as CC\n        where CC.parentClassId = ?\n        `,\n        [item.id]\n      ),\n    }))\n  );\n\nexport const student = ({ classIds, keyword, subjects, byGrade = true, limit = 10, offset = 0 }, loggedUserId) =>\n  beginTransaction(async trans => {\n    const rows = await trans\n      .select(\n        `\n        select\n          C.id,\n          C.title,\n          T.id as teacherId,\n          T.userId as teacherUserId,\n          T.name as teacherName\n        from classesSubjects as CS\n        join classes as C on C.id = CS.classId\n        inner join teachers as T on T.userId = C.userId\n        join students as S on S.userId = ?\n        where 1 = 1\n          ${byGrade === true ? `AND C.gradeId = S.gradeId` : \"\"}\n          ${subjects ? `AND CS.subjectId in (${subjects.join()})` : \"\"}\n          ${classIds ? `AND C.id in (${classIds.join()})` : \"\"}\n          ${keyword ? `AND C.title like ${like(keyword)}` : \"\"}\n        group by C.id\n        order by C.createdAt desc\n        limit ${limit} offset ${offset}\n        `,\n        [loggedUserId]\n      )\n      .then(value => formatClasses(value, trans));\n\n    const { count: total } = await trans.first(\n      `\n      select\n        count(distinct C.id) as count\n      from classesSubjects as CS\n      join classes as C on C.id = CS.classId\n      inner join teachers as T on T.userId = C.userId\n      join students as S on S.userId = ?\n      where 1 = 1\n        ${byGrade === true ? `AND C.gradeId = S.gradeId` : \"\"}\n        ${subjects ? `AND CS.subjectId in (${subjects.join()})` : \"\"}\n        ${classIds ? `AND C.id in (${classIds.join()})` : \"\"}\n        ${keyword ? `AND C.title like ${like(keyword)}` : \"\"}\n      `,\n      [loggedUserId]\n    );\n\n    return {\n      limit,\n      offset,\n      filters: { byGrade, classIds, keyword, subjects },\n      total,\n      rows,\n    };\n  });\n\nexport const teacher = ({ classIds, keyword, subjects, limit = 10, offset = 0 }) =>\n  beginTransaction(async trans => {\n    const rows = await trans\n      .select(\n        `\n        select\n          C.id,\n          C.title,\n          T.id as teacherId,\n          T.userId as teacherUserId,\n          T.name as teacherName\n        from classesSubjects as CS\n        join classes as C on C.id = CS.classId\n        inner join teachers as T on T.userId = C.userId\n        where 1 = 1\n          ${subjects ? `AND CS.subjectId in (${subjects.join()})` : \"\"}\n          ${classIds ? `AND C.id in (${classIds.join()})` : \"\"}\n          ${keyword ? `AND C.title like ${like(keyword)}` : \"\"}\n        group by C.id\n        order by C.createdAt desc\n        limit ${limit} offset ${offset}\n      `\n      )\n      .then(value => formatClasses(value, trans));\n\n    const { count: total } = await trans.first(\n      `\n      select\n        count(distinct C.id) as count\n      from classesSubjects as CS\n      join classes as C on C.id = CS.classId\n      inner join teachers as T on T.userId = C.userId\n      where 1 = 1\n        ${subjects ? `AND CS.subjectId in (${subjects.join()})` : \"\"}\n        ${classIds ? `AND C.id in (${classIds.join()})` : \"\"}\n        ${keyword ? `AND C.title like ${like(keyword)}` : \"\"}\n      `\n    );\n\n    return {\n      limit,\n      offset,\n      filters: { classIds, keyword, subjects },\n      total,\n      rows,\n    };\n  });\n"],"file":"list-with-content.js"}